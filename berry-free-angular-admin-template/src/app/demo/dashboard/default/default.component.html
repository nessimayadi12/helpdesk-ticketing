<div class="row g-3">
  <!-- Admin view -->
  <ng-container *ngIf="isAdmin && adminVM as a">
                  <div class="col-12 col-md-3">
                    <div class="card">
                      <div class="card-header"><h5>Tickets (Total)</h5></div>
                      <div class="card-block">
                        <h2 class="mb-1">{{ a.total }}</h2>
                        <small class="text-muted">Tous les tickets</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-md-5">
                    <div class="card">
                      <div class="card-header"><h5>Par statut</h5></div>
                      <div class="card-block">
                        <ul class="list-unstyled mb-0">
                          <li *ngFor="let s of a.status" class="py-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <span class="badge" [ngClass]="statusBadgeClass(s.name)">{{ s.name }}</span>
                              <span><strong>{{ s.count }}</strong> <small class="text-muted">({{ s.percent }}%)</small></span>
                            </div>
                            <div class="progress mt-1" style="height:6px">
                              <div class="progress-bar" [ngClass]="progressBarClass(s.name)" role="progressbar" [style.width.%]="s.percent"></div>
                            </div>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-md-4">
                    <div class="card">
                      <div class="card-header"><h5>Par utilisateur</h5></div>
                      <div class="card-block">
                        <ul class="list-unstyled mb-0">
                          <li *ngFor="let u of a.users" class="d-flex justify-content-between align-items-center py-1">
                            <span>{{ u.username }}</span>
                            <strong>{{ u.count }}</strong>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="card">
                      <div class="card-header"><h5>Derniers tickets</h5></div>
                      <div class="card-block">
                        <div class="table-responsive">
                          <table class="table table-sm align-middle mb-0">
                            <thead>
                              <tr>
                                <th>#</th>
                                <th>Titre</th>
                                <th>Propriétaire</th>
                                <th>Statut</th>
                                <th>Créé le</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr *ngFor="let t of a.latest">
                                <td><a [routerLink]="['/tickets', t.id]">{{ t.id }}</a></td>
                                <td class="text-truncate" style="max-width: 320px"><a [routerLink]="['/tickets', t.id]">{{ t.title || t.sujet }}</a></td>
                                <td>{{ t.user || '-' }}</td>
                                <td><span class="badge" [ngClass]="statusBadgeClass(t.status)">{{ t.status }}</span></td>
                                <td>{{ t.createdAt | date:'short' }}</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>

                <!-- User view -->
                <ng-container *ngIf="!isAdmin && meVM as m">
                  <div class="col-12 col-md-4">
                    <div class="card">
                      <div class="card-header"><h5>Mes tickets (Total)</h5></div>
                      <div class="card-block">
                        <h2 class="mb-1">{{ m.total }}</h2>
                        <small class="text-muted">Créés par moi</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-md-4">
                    <div class="card">
                      <div class="card-header"><h5>Par statut</h5></div>
                      <div class="card-block">
                        <ul class="list-unstyled mb-0">
                          <li *ngFor="let s of m.status" class="py-2">
                            <div class="d-flex justify-content-between align-items-center">
                              <span class="badge" [ngClass]="statusBadgeClass(s.name)">{{ s.name }}</span>
                              <span><strong>{{ s.count }}</strong> <small class="text-muted">({{ s.percent }}%)</small></span>
                            </div>
                            <div class="progress mt-1" style="height:6px">
                              <div class="progress-bar" [ngClass]="progressBarClass(s.name)" role="progressbar" [style.width.%]="s.percent"></div>
                            </div>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-md-4">
                    <div class="card">
                      <div class="card-header"><h5>Activité (7 jours)</h5></div>
                      <div class="card-block">
                        <ul class="list-unstyled mb-0">
                          <li *ngFor="let d of m.activity" class="d-flex align-items-center py-1">
                            <small class="text-muted" style="width:70px">{{ d.label }}</small>
                            <div class="progress flex-grow-1 mx-2" style="height:6px">
                              <div class="progress-bar bg-primary" role="progressbar" [style.width.%]="d.percent"></div>
                            </div>
                            <small class="text-muted" style="width:30px; text-align:right">{{ d.count }}</small>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-md-6">
                    <div class="card">
                      <div class="card-header"><h5>Dernières mises à jour</h5></div>
                      <div class="card-block">
                        <ul class="list-unstyled mb-0">
                          <li *ngFor="let t of m.recentUpdated" class="d-flex justify-content-between align-items-center py-1">
                            <span class="text-truncate" style="max-width: 70%"><a [routerLink]="['/tickets', t.id]">#{{ t.id }} · {{ t.title || t.sujet }}</a></span>
                            <span>
                              <span class="badge me-2" [ngClass]="statusBadgeClass(t.status)">{{ t.status }}</span>
                              <small class="text-muted">{{ t.updatedAt | date:'short' }}</small>
                            </span>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-md-6">
                    <div class="card">
                      <div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0">Top tickets commentés</h5><small class="text-muted">Total: {{ m.comments?.total || 0 }}</small></div>
                      <div class="card-block">
                        <ul class="list-unstyled mb-0">
                          <li *ngFor="let t of m.comments?.top" class="d-flex justify-content-between align-items-center py-1">
                            <span class="text-truncate" style="max-width: 70%"><a [routerLink]="['/tickets', t.id]">#{{ t.id }} · {{ t.title }}</a></span>
                            <span class="badge bg-secondary text-white">{{ t.count }}</span>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
    </ng-container>
    <ng-container *ngIf="!isAdmin && !meVM">
      <div class="col-12">
        <div class="card">
          <div class="card-block">
            <small class="text-muted">Aucune statistique disponible pour le moment. Vérifiez votre connexion et l’authentification.</small>
          </div>
        </div>
      </div>
    </ng-container>
</div>

